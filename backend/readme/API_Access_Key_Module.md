## API Access Key Module

### Overview
This module allows authenticated portal clients to generate and manage **service access keys** for server-to-server API calls.

- **Access Key ID**: Public identifier (safe to log and display in UI)
- **Access Key Secret**: Private secret (shown only once, stored hashed like a password)
- Keys are stored in a dedicated MongoDB collection: `service_access_keys`.
- Keys are linked to the portal client via `client_id`.

---

### Key Format

- **Access Key ID**: `ak_{environment}_{random}`
  - Example: `ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h`
- **Access Key Secret**: `sk_{environment}_{random}`
  - Example: `sk_live_Yl0nQ3rS8wO5xV9zW2aB4cD6eF7gH9i`
- `environment` is `live` or `test`.
- `random` is a cryptographically secure base64url string generated with Node.js `crypto.randomBytes`.

Keys are generated by `keyGenerator`:

- `generateAccessKeyId(environment)`
- `generateAccessKeySecret(environment)`

---

### Database Schema

Collection: `service_access_keys`

Fields:
- `id` (String, UUID) – Primary identifier
- `access_key_id` (String, unique, indexed)
- `access_key_secret_hash` (String, bcrypt hash of secret)
- `client_id` (String, UUID from `clients.id`)
- `is_active` (Boolean, default: true)
- `rate_limit` (Number, default: 1000 requests/hour)
- `revoked_at` (Date, nullable)
- `createdAt`, `updatedAt` (timestamps)

---

### API Endpoints

Base path for client auth APIs:
- `/api/v1/client/auth`

#### 1. Generate API Access Key

- **Method**: `POST`
- **URL**: `/api/v1/client/auth/api-clients`
- **Auth**: `Bearer <portal_access_token>` (JWT from login)

**Request Body (JSON):**
```json
{
  "environment": "live",  
  "rate_limit": 1000       
}
```

- `environment` (optional): `live` or `test` (default: `live`)
- `rate_limit` (optional): positive number (requests per hour, default: 1000)

**Success Response (201):**
```json
{
  "success": true,
  "message": "API access key generated successfully",
  "data": {
    "access_key_id": "ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h",
    "access_key_secret": "sk_live_Yl0nQ3rS8wO5xV9zW2aB4cD6eF7gH9i",
    "client_id": "550e8400-e29b-41d4-a716-446655440000",
    "rate_limit": 1000,
    "created_at": "2024-01-15T10:30:00.000Z",
    "warning": "⚠️ Store your access_key_secret securely. It will not be shown again."
  }
}
```

> **Important:** `access_key_secret` is returned **only once**. It is stored hashed in the database and cannot be recovered.

---

#### 2. List API Access Keys

- **Method**: `GET`
- **URL**: `/api/v1/client/auth/api-clients`
- **Auth**: `Bearer <portal_access_token>`

**Success Response (200):**
```json
{
  "success": true,
  "message": "API access keys retrieved successfully",
  "data": [
    {
      "id": "key-uuid-1",
      "access_key_id": "ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h",
      "client_id": "550e8400-e29b-41d4-a716-446655440000",
      "is_active": true,
      "rate_limit": 1000,
      "created_at": "2024-01-15T10:30:00.000Z",
      "revoked_at": null
    }
  ]
}
```

Secrets are **never** returned in this endpoint.

---

#### 3. Revoke API Access Key

- **Method**: `DELETE`
- **URL**: `/api/v1/client/auth/api-clients/:access_key_id`
- **Auth**: `Bearer <portal_access_token>`

**Success Response (200):**
```json
{
  "success": true,
  "message": "API access key revoked successfully",
  "data": {
    "access_key_id": "ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h",
    "revoked_at": "2024-01-16T09:00:00.000Z"
  }
}
```

---

### Using the Access Key in Service Requests

Clients call your APIs with the access key in the `Authorization` header:

```http
Authorization: AccessKey ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h:sk_live_Yl0nQ3rS8wO5xV9zW2aB4cD6eF7gH9i
```

Example:

```bash
curl -X POST http://localhost:5002/api/v1/client/auth/login \
  -H "Content-Type: application/json" \
  -H "Authorization: AccessKey ak_live_Xk9mP2qR7vN4wT8yU1zA3bC5dE6fG8h:sk_live_Yl0nQ3rS8wO5xV9zW2aB4cD6eF7gH9i" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123"
  }'
```

On the server side, `accessKeyMiddleware` validates the key and attaches:

```js
req.serviceClient = {
  id,
  access_key_id,
  client_id,
  rate_limit,
  created_at
};
```

You can then use `req.serviceClient` in your controllers for authorization, logging, and rate limiting.

---

### Security Notes

- Access key secrets are hashed using bcrypt (same as passwords).
- Access keys can be revoked (`is_active = false`, `revoked_at` set).
- Generation endpoint is rate limited (5 requests per 15 minutes per IP).
- Only authenticated portal clients (JWT) can generate, list, or revoke keys.

